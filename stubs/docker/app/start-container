#!/usr/bin/env bash
set -Eeuo pipefail

main() {
    echo_block "Starting container..."

    bootstrap_env
    extra_configs
    composer_show_version || exit 1
    composer_warm_up || exit 1
    composer_validate || exit 1
    composer_update_keys || true
    composer_diag || true
    composer_install || exit 1
    composer_check_platform_reqs || exit 1
    npm_warm_up || exit 1
    laravel_warm_up || exit 1

    echo_block "Application container is ready"
    exec /usr/bin/supervisord -c /etc/supervisord.conf
}

bootstrap_env() {
    # App dir (default: /code)
    export APP_INSTALL_DIR="${APP_INSTALL_DIR:-/code}"
    cd "$APP_INSTALL_DIR"

    # Composer dirs INSIDE project
    export COMPOSER_HOME="${COMPOSER_HOME:-$APP_INSTALL_DIR/.composer}"
    export COMPOSER_CACHE_DIR="${COMPOSER_CACHE_DIR:-$COMPOSER_HOME/cache}"
    mkdir -p "$COMPOSER_HOME" "$COMPOSER_CACHE_DIR"
    mkdir -p "$COMPOSER_HOME/cache/files"

    global_flags="--ansi"
}

extra_configs() {

    if [ -f "$APP_INSTALL_DIR/.docker/app/conf.d/php.ini" ]; then
        cp -f "$APP_INSTALL_DIR/.docker/app/conf.d/php.ini" /usr/local/etc/php/conf.d/97-php.ini
    fi

    # Only copy dev custom.ini if the file actually exists
    if [[ "${TOOLBOX_STARTER_MODE:-dev}" == "dev" ]] && [ -f "$APP_INSTALL_DIR/.docker/app/conf.d/custom.ini.dev" ]; then
        cp -f "$APP_INSTALL_DIR/.docker/app/conf.d/custom.ini.dev" /usr/local/etc/php/conf.d/98-custom.ini
    fi

    if [ -f "$APP_INSTALL_DIR/.docker/app/conf.d/custom.ini" ]; then
        cp -f "$APP_INSTALL_DIR/.docker/app/conf.d/custom.ini" /usr/local/etc/php/conf.d/99-custom.ini
    fi
}

composer_show_version() {
    local out

    if ! out="$(composer --version 2>&1)"; then
        echo_fail "composer --version failed"
        return 1
    fi

    while IFS= read -r line; do
        [ -n "$line" ] && echo_info "$line"
    done <<< "$out"
}

composer_warm_up() {
    # Minimal files if missing
    [ -f "$COMPOSER_HOME/config.json" ]   || echo '{}' > "$COMPOSER_HOME/config.json"
    [ -f "$COMPOSER_HOME/composer.json" ] || echo '{}' > "$COMPOSER_HOME/composer.json"

    # Keep Packagist unless a COMPOSER_MIRROR_URL is explicitly provided
    if [ -n "${COMPOSER_MIRROR_URL:-}" ]; then
        local base="${COMPOSER_MIRROR_URL}"
        composer config -g repositories.custom composer "${base}" || true
        composer config -g repo.packagist false || true
    fi
}

composer_validate() {
    echo_info "Validating composer..."
    local out

    if out="$(composer validate $global_flags 2>&1)"; then
        echo_success "composer.json is valid"
        return 0
    fi

    echo_warning "composer validate reported issues:"
    printf '%s\n' "$out"

    echo_info "Running composer update (to fix lock/metadata)"
    if ! composer_repo_available; then
        echo_warning "composer repository is not reachable, skipping update"
        return 0
    fi
    if [[ "${TOOLBOX_STARTER_MODE:-dev}" == "prod" ]]; then
        composer update --no-dev $global_flags
    else
        composer update $global_flags
    fi
}

composer_update_keys() {
    if ! composer_install_needed; then
        echo_info "composer dependencies are up to date, skipping GPG key update"
        return 0
    fi

    if [[ ! -f "$COMPOSER_HOME/keys.dev.pub" || ! -f "$COMPOSER_HOME/keys.tags.pub" ]]; then
        echo_info "Updating Composer GPG keys..."

        if [[ -n "${COMPOSER_GITHUB_URL:-}" ]]; then
            base="${COMPOSER_GITHUB_URL%/}"
        else
            base="https://composer.github.io"
        fi

        if ! url_is_reachable "${base}"; then
            echo_warning "Composer key host is not reachable, skipping key update"
            return 0
        fi

        curl -fsS "${base}/snapshots.pub" -o "$COMPOSER_HOME/keys.dev.pub"  || true
        curl -fsS "${base}/releases.pub"  -o "$COMPOSER_HOME/keys.tags.pub" || true
    fi
}


composer_diag() {
    echo_info "diagnosing composer..."

    # If composer repository is not reachable, skip
    if ! composer_repo_available; then
        echo_warning "composer repository is not reachable, skipping composer diag"
        return 0
    fi

    local diag_output
    # Composer diag returns non-zero on warnings; don't fail the container
    if diag_output="$(composer diag $global_flags 2>&1)"; then
        echo_success "composer diag: OK"
    else
        echo_warning "composer diag reported issues:"
        while IFS= read -r line; do
            echo_warning "composer diag: $line"
        done <<< "$diag_output"
    fi

    return 0
}

composer_check_platform_reqs() {
    echo_info "checking platform requirements..."
    local out

    if out="$(composer check-platform-reqs $global_flags 2>&1)"; then
        echo_success "composer platform requirements satisfied"
        return 0
    fi

    echo_fail "composer platform requirements are not satisfied"
    printf '%s\n' "$out"
    return 1
}

hash_files() {
    local hasher
    local files=("$@")

    if command -v sha256sum >/dev/null 2>&1; then
        hasher="sha256sum"
    elif command -v shasum >/dev/null 2>&1; then
        hasher="shasum -a 256"
    else
        echo ""
        return 0
    fi

    if [ "${#files[@]}" -eq 0 ]; then
        echo ""
        return 0
    fi

    local combined
    combined="$($hasher "${files[@]}" 2>/dev/null | awk '{print $1}' | tr '\n' ' ')"
    printf '%s' "$combined" | $hasher | awk '{print $1}'
}

composer_state_hash() {
    local files=()
    [ -f "composer.json" ] && files+=("composer.json")
    [ -f "composer.lock" ] && files+=("composer.lock")
    hash_files "${files[@]}"
}

composer_install_needed() {
    if [ ! -f "composer.json" ]; then
        return 1
    fi
    if [ ! -f "composer.lock" ]; then
        return 0
    fi
    if [ ! -f "vendor/autoload.php" ]; then
        return 0
    fi

    local stamp="${APP_INSTALL_DIR:-.}/.composer-install.stamp"
    local hash prev
    hash="$(composer_state_hash)"
    if [ -n "$hash" ] && [ -f "$stamp" ]; then
        prev="$(cat "$stamp" 2>/dev/null || true)"
        if [ "$hash" = "$prev" ]; then
            return 1
        fi
    fi

    if [ "composer.lock" -nt "vendor/autoload.php" ] || [ "composer.json" -nt "vendor/autoload.php" ]; then
        return 0
    fi

    if [ -n "$hash" ]; then
        printf '%s' "$hash" > "$stamp"
    fi

    return 1
}

npm_state_hash() {
    local files=()
    [ -f "package.json" ] && files+=("package.json")
    [ -f "package-lock.json" ] && files+=("package-lock.json")
    [ -f "npm-shrinkwrap.json" ] && files+=("npm-shrinkwrap.json")
    hash_files "${files[@]}"
}

npm_build_needed() {
    local stamp="${APP_INSTALL_DIR:-.}/.npm-build.stamp"
    local hash
    hash="$(npm_state_hash)"
    if [ -z "$hash" ]; then
        return 0
    fi
    if [ ! -f "$stamp" ]; then
        return 0
    fi
    local prev
    prev="$(cat "$stamp" 2>/dev/null || true)"
    if [ "$hash" != "$prev" ]; then
        return 0
    fi
    return 1
}

composer_install() {
    echo_info "installing composer dependencies..."

    if ! composer_repo_available; then
        echo_warning "composer repository is not reachable, skipping install"
        return 0
    fi

    local base_flags="--ansi --no-interaction --optimize-autoloader"
    if [[ "${TOOLBOX_STARTER_MODE:-dev}" == "prod" ]]; then
        if ! composer_install_needed; then
            echo_success "composer dependencies are up to date, skipping install"
            return 0
        fi
        if composer install --no-dev $base_flags; then
            echo_success "composer dependencies installed (prod)"
            composer_state_hash > "${APP_INSTALL_DIR:-.}/.composer-install.stamp" || true
            return 0
        else
            echo_fail "composer install failed (prod)"
            return 1
        fi
    else
        if ! composer_install_needed; then
            echo_success "composer dependencies are up to date, skipping install"
            return 0
        fi
        if composer install $base_flags; then
            echo_success "composer dependencies installed"
            composer_state_hash > "${APP_INSTALL_DIR:-.}/.composer-install.stamp" || true
            return 0
        else
            echo_fail "composer install failed"
            return 1
        fi
    fi
}

laravel_warm_up() {
    local artisan_version out

    if ! artisan_version="$(php artisan --version --ansi 2>&1)"; then
        echo_fail "php artisan command failed"
        return 1
    fi

    echo_info "$artisan_version"

    evaluate_custom_commands

    if out="$(php artisan optimize:clear $global_flags 2>&1)"; then
        echo_success "laravel optimize was cleared"
    else
        echo_warning "laravel optimize:clear failed (non-fatal)"
        printf '%s\n' "$out"
    fi

    if [ "${TOOLBOX_STARTER_MODE:-dev}" = "prod" ]; then
        if out="$(php artisan optimize $global_flags 2>&1)"; then
            echo_success "laravel optimized"
        else
            echo_warning "laravel optimize failed (non-fatal)"
            printf '%s\n' "$out"
        fi

        # Copy rr binary into project root (optional)
        cp /usr/local/bin/rr . 2>/dev/null || true
        echo_block_prod "PRODUCTION MODE"
    else
        echo_block "DEVELOPMENT MODE"
    fi
}

npm_warm_up() {
    if [ ! -f package.json ]; then
        echo_warning "package.json not found, skipping npm install/build"
        return 0
    fi

    if ! npm_build_needed; then
        echo_success "npm dependencies/build are up to date, skipping install/build"
        return 0
    fi

    if [ -n "${NPM_MIRROR_URL:-}" ]; then
        local base="${NPM_MIRROR_URL%/}"
        npm config set registry "${base}"
    fi

    echo_info "npm registry: $(npm config get registry)"
    echo_info "npm version: $(npm --version)"

    echo_info "npm install (this may take a while...)"
    local npm_log="${APP_INSTALL_DIR:-.}/.npm-install.log"
    : >"$npm_log"

    if ! npm_registry_available; then
        echo_warning "npm registry is not reachable, skipping install/build"
        return 0
    fi

    if npm install --no-progress --loglevel=error >"$npm_log" 2>&1; then
        echo_success "npm install completed"
        rm -f "$npm_log" || true
    else
        echo_fail "npm install failed"
        printf '%s\n' "----- npm install output -----"
        cat "$npm_log"
        return 1
    fi

    echo_info "npm run build"
    local build_output
    if build_output="$(npm run build 2>&1)"; then
        echo_success "npm run build completed"
        npm_state_hash > "${APP_INSTALL_DIR:-.}/.npm-build.stamp" || true

        if [ -d node_modules ]; then
            echo_info "Cleaning node_modules after build"
            rm -rf node_modules
        fi
    else
        echo_fail "npm run build failed"
        printf '%s\n' "$build_output"
        return 1
    fi

    return 0
}

evaluate_custom_commands () {
    if [[ -n "${CUSTOM_COMMANDS:-}" ]]; then
        echo_block "Running custom commands..."
        eval "${CUSTOM_COMMANDS}"
        echo_success "All custom commands evaluated"
    fi
}

url_is_reachable() {
    local url="$1"

    if curl -fsS --head --max-time 5 "$url" >/dev/null 2>&1; then
        return 0
    fi

    if curl -fsS --max-time 5 "$url" >/dev/null 2>&1; then
        return 0
    fi

    return 1
}

composer_repo_available() {
    local base

    if [ -n "${COMPOSER_MIRROR_URL:-}" ]; then
        base="${COMPOSER_MIRROR_URL%/}"
    else
        base="https://repo.packagist.org"
    fi

    echo_info "checking composer repository: ${base}"
    url_is_reachable "${base}"
}

npm_registry_available() {
    local registry

    registry="$(npm config get registry)"
    registry="${registry%/}"

    echo_info "checking npm registry: ${registry}"
    url_is_reachable "${registry}"
}

echo_block()      { printf "\n\e[1;30;46m %s \e[0m\n\n" "$@"; }
echo_block_prod() { printf "\n\e[1;97;41m %s \e[0m\n\n" "$@"; }
echo_info()       { printf "\n\e[36mⓘ  %s\e[0m\n" "$@"; }
echo_success()    { printf "\n\e[32m✔  %s\e[0m\n" "$@"; }
echo_warning()    { printf "\n\e[36m⚠  %s\e[0m\n" "$@"; }
echo_fail()       { printf "\n\e[31m✘  %s\e[0m\n" "$@"; }

if [ $# -gt 0 ]; then
    exec "$@"
else
    main "$@"
fi
