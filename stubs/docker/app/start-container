#!/usr/bin/env bash
set -Eeuo pipefail

main() {
    echo_block "Starting container..."

    bootstrap_env
    extra_configs
    composer_show_version || exit 1
    composer_warm_up || exit 1
    composer_validate || exit 1
    composer_update_keys || true
    composer_diag || true
    composer_install || exit 1
    composer_check_platform_reqs || exit 1
    npm_warm_up || exit 1
    laravel_warm_up || exit 1

    echo_block "Application container is ready"
    exec /usr/bin/supervisord -c /etc/supervisord.conf
}

bootstrap_env() {
    # App dir (default: /code)
    export APP_INSTALL_DIR="${APP_INSTALL_DIR:-/code}"
    cd "$APP_INSTALL_DIR"

    # Composer dirs INSIDE project
    export COMPOSER_HOME="${COMPOSER_HOME:-$APP_INSTALL_DIR/.composer}"
    export COMPOSER_CACHE_DIR="${COMPOSER_CACHE_DIR:-$COMPOSER_HOME/cache}"
    mkdir -p "$COMPOSER_HOME" "$COMPOSER_CACHE_DIR"
    mkdir -p "$COMPOSER_HOME/cache/files"

    global_flags="--ansi"
}

extra_configs() {

    if [ -f "$APP_INSTALL_DIR/.docker/app/conf.d/php.ini" ]; then
        cp -f "$APP_INSTALL_DIR/.docker/app/conf.d/php.ini" /usr/local/etc/php/conf.d/97-php.ini
    fi

    # Only copy dev custom.ini if the file actually exists
    if [[ "${TOOLBOX_STARTER_MODE:-dev}" == "dev" ]] && [ -f "$APP_INSTALL_DIR/.docker/app/conf.d/custom.ini.dev" ]; then
        cp -f "$APP_INSTALL_DIR/.docker/app/conf.d/custom.ini.dev" /usr/local/etc/php/conf.d/98-custom.ini
    fi

    if [ -f "$APP_INSTALL_DIR/.docker/app/conf.d/custom.ini" ]; then
        cp -f "$APP_INSTALL_DIR/.docker/app/conf.d/custom.ini" /usr/local/etc/php/conf.d/99-custom.ini
    fi
}

composer_show_version() {
    local out

    if ! out="$(composer --version 2>&1)"; then
        echo_fail "composer --version failed"
        return 1
    fi

    while IFS= read -r line; do
        [ -n "$line" ] && echo_info "$line"
    done <<< "$out"
}

composer_warm_up() {
    # Minimal files if missing
    [ -f "$COMPOSER_HOME/config.json" ]   || echo '{}' > "$COMPOSER_HOME/config.json"
    [ -f "$COMPOSER_HOME/composer.json" ] || echo '{}' > "$COMPOSER_HOME/composer.json"

    # Keep Packagist unless a COMPOSER_MIRROR_URL is explicitly provided
    if [ -n "${COMPOSER_MIRROR_URL:-}" ]; then
        local base="${COMPOSER_MIRROR_URL}"
        composer config -g repositories.custom composer "${base}" || true
        composer config -g repo.packagist false || true
    fi
}

composer_validate() {
    echo_info "Validating composer..."
    local out

    if out="$(composer validate $global_flags 2>&1)"; then
        echo_success "composer.json is valid"
        return 0
    fi

    echo_warning "composer validate reported issues:"
    printf '%s\n' "$out"

    echo_info "Running composer update (to fix lock/metadata)"
    if [[ "${TOOLBOX_STARTER_MODE:-dev}" == "prod" ]]; then
        composer update --no-dev $global_flags
    else
        composer update $global_flags
    fi
}

composer_update_keys() {
    if [[ ! -f "$COMPOSER_HOME/keys.dev.pub" || ! -f "$COMPOSER_HOME/keys.tags.pub" ]]; then
        echo_info "Updating Composer GPG keys..."

        if [[ -n "${COMPOSER_GITHUB_URL:-}" ]]; then
            base="${COMPOSER_GITHUB_URL%/}"
        else
            base="https://composer.github.io"
        fi

        curl -fsS "${base}/snapshots.pub" -o "$COMPOSER_HOME/keys.dev.pub"  || true
        curl -fsS "${base}/releases.pub"  -o "$COMPOSER_HOME/keys.tags.pub" || true
    fi
}


composer_diag() {
    [[ "${COMPOSER_DIAG_ENABLED:-1}" =~ ^(1|true|yes|on)$ ]] || {
        echo_info "composer diag: disabled (COMPOSER_DIAG_ENABLED=${COMPOSER_DIAG_ENABLED-<unset>})"
        return 0
    }
    echo_info "diagnosing composer..."

    # If no internet, skip
    if ! ping -c 1 8.8.8.8 >/dev/null 2>&1; then
        echo_warning "No internet connectivity, skipping composer diag"
        return 0
    fi

    local diag_output
    # Composer diag returns non-zero on warnings; don't fail the container
    if diag_output="$(composer diag $global_flags 2>&1)"; then
        echo_success "composer diag: OK"
    else
        echo_warning "composer diag reported issues:"
        while IFS= read -r line; do
            echo_warning "composer diag: $line"
        done <<< "$diag_output"
    fi

    return 0
}

composer_check_platform_reqs() {
    echo_info "checking platform requirements..."
    local out

    if out="$(composer check-platform-reqs $global_flags 2>&1)"; then
        echo_success "composer platform requirements satisfied"
        return 0
    fi

    echo_fail "composer platform requirements are not satisfied"
    printf '%s\n' "$out"
    return 1
}

composer_install() {
    echo_info "installing composer dependencies..."

    local base_flags="--ansi --no-interaction --optimize-autoloader"
    if [[ "${TOOLBOX_STARTER_MODE:-dev}" == "prod" ]]; then
        if composer install --no-dev $base_flags; then
            echo_success "composer dependencies installed (prod)"
            return 0
        else
            echo_fail "composer install failed (prod)"
            return 1
        fi
    else
        if [ -f "vendor/autoload.php" ]; then
            if composer install --dry-run $base_flags; then
                echo_warning "Only dry-run. Don't forget to run 'composer install'"
                echo_success "composer dry-run completed"
                return 0
            else
                echo_fail "composer install dry-run failed"
                return 1
            fi
        else
            if composer install $base_flags; then
                echo_success "composer dependencies installed"
                return 0
            else
                echo_fail "composer install failed"
                return 1
            fi
        fi
    fi
}

laravel_warm_up() {
    local artisan_version out

    if ! artisan_version="$(php artisan --version --ansi 2>&1)"; then
        echo_fail "php artisan command failed"
        return 1
    fi

    echo_info "$artisan_version"

    evaluate_custom_commands

    if out="$(php artisan optimize:clear $global_flags 2>&1)"; then
        echo_success "laravel optimize was cleared"
    else
        echo_warning "laravel optimize:clear failed (non-fatal)"
        printf '%s\n' "$out"
    fi

    if [ "${TOOLBOX_STARTER_MODE:-dev}" = "prod" ]; then
        if out="$(php artisan optimize $global_flags 2>&1)"; then
            echo_success "laravel optimized"
        else
            echo_warning "laravel optimize failed (non-fatal)"
            printf '%s\n' "$out"
        fi

        # Copy rr binary into project root (optional)
        cp /usr/local/bin/rr . 2>/dev/null || true
        echo_block_prod "PRODUCTION MODE"
    else
        echo_block "DEVELOPMENT MODE"
    fi
}

npm_warm_up() {
    if [ ! -f package.json ]; then
        echo_warning "package.json not found, skipping npm install/build"
        return 0
    fi

    if [ -n "${NPM_MIRROR_URL:-}" ]; then
        local base="${NPM_MIRROR_URL%/}"
        npm config set registry "${base}"
    fi

    echo_info "npm registry: $(npm config get registry)"
    echo_info "npm version: $(npm --version)"

    echo_info "npm install (this may take a while...)"
    local npm_log="${APP_INSTALL_DIR:-.}/.npm-install.log"
    : >"$npm_log"

    if npm install --no-progress --loglevel=error >"$npm_log" 2>&1; then
        echo_success "npm install completed"
        rm -f "$npm_log" || true
    else
        echo_fail "npm install failed"
        printf '%s\n' "----- npm install output -----"
        cat "$npm_log"
        return 1
    fi

    echo_info "npm run build"
    local build_output
    if build_output="$(npm run build 2>&1)"; then
        echo_success "npm run build completed"

        if [ -d node_modules ]; then
            echo_info "Cleaning node_modules after build"
            rm -rf node_modules
        fi
    else
        echo_fail "npm run build failed"
        printf '%s\n' "$build_output"
        return 1
    fi

    return 0
}

evaluate_custom_commands () {
    if [[ -n "${CUSTOM_COMMANDS:-}" ]]; then
        echo_block "Running custom commands..."
        eval "${CUSTOM_COMMANDS}"
        echo_success "All custom commands evaluated"
    fi
}

echo_block()      { printf "\n\e[1;30;46m %s \e[0m\n\n" "$@"; }
echo_block_prod() { printf "\n\e[1;97;41m %s \e[0m\n\n" "$@"; }
echo_info()       { printf "\n\e[36mⓘ  %s\e[0m\n" "$@"; }
echo_success()    { printf "\n\e[32m✔  %s\e[0m\n" "$@"; }
echo_warning()    { printf "\n\e[36m⚠  %s\e[0m\n" "$@"; }
echo_fail()       { printf "\n\e[31m✘  %s\e[0m\n" "$@"; }

if [ $# -gt 0 ]; then
    exec "$@"
else
    main "$@"
fi
